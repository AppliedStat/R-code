
#============================================
# Hodges-Lehmann estimators
#============================================
#  i < j 
HL1 <- function(x,IncludeEqual=FALSE,na.rm=FALSE) {
  if (na.rm) x <- x[!is.na(x)]
  w = outer(x,x, "+")
  0.5 * median( w[lower.tri(w,diag=IncludeEqual)] )
}
# i <= j 
HL2<- function(x,IncludeEqual=TRUE,na.rm=FALSE) {
  if (na.rm) x <- x[!is.na(x)]
  w = outer(x,x, "+")
  0.5 * median( w[lower.tri(w,diag=IncludeEqual)] )
}
# All (i,j). 
HL3 <- function(x, na.rm=FALSE) {
  if (na.rm) x <- x[!is.na(x)]
  0.5 * median( outer(x,x, "+") )
}
#============================================
# Shamos (i < j) 
#============================================
Shamos <- function(x,b=1.048358, IncludeEqual=FALSE, na.rm=FALSE) {
  if (na.rm) x <- x[!is.na(x)]
  w1 = outer(x,x, "-")
  w2 = abs( w1[lower.tri(w1,diag=IncludeEqual)]  )
  b * median( w2 )
}
#--------------------------------------------


#============================================
# Finite Breakdown 
#============================================
#
# median
#
breakdown.median <- function(n) {
   floor(0.5*(n-1)) / n
}
#
# Hodges-Lehmann
#
breakdown.HL1 <- function(n){  # using  i < j
   if ( n <=1 ) return(0)
   tmp1 = floor( (n*(n-1)-2)/4 ) 
   tmp2 =  ( (2*n-1) - sqrt( (2*n-1)^2-8*tmp1 ) ) / 2
   m = floor(tmp2) 
   m / n
}
breakdown.HL2 <- function(n){  # using  i <= j
   if ( n <=1 ) return(0)
   tmp1 = floor( (n*(n+1)-2)/4 )
   tmp2 =  ( (2*n+1) - sqrt( (2*n+1)^2-8*tmp1 ) ) / 2
   m = floor(tmp2)
   m / n
}
breakdown.HL3 <- function(n){  # using all (i,j)
   if ( n <=1 ) return(0)
   tmp = floor(0.5*(n^2-1))
   m   = floor( n - sqrt(n^2-tmp) )
   m / n
}
#
# Shamos (same as the breakdown points of HL1)
#
breakdown.Shamos = breakdown.HL1 
#============================================


#============================================
# Empirical biases
#============================================
#
# mad
#
n.times.eBias.of.mad = 
c(NA,-0.326776, -0.982769, -1.05931, -0.890625, -0.956528, -0.847442,
-0.905542, -0.828592, -0.874503, -0.815433, -0.853694, -0.807194,
-0.840294, -0.801905, -0.830475, -0.794442, -0.820043, -0.793352,
-0.816497, -0.791631, -0.81037, -0.787507, -0.804936, -0.782663,
-0.805389, -0.783593, -0.803807, -0.780485, -0.796354, -0.777275,
-0.794166, -0.780317, -0.791548, -0.777345, -0.794723, -0.777478,
-0.787773, -0.77716, -0.788559, -0.772627, -0.790452, -0.776239,
-0.784012, -0.773396, -0.785663, -0.777337, -0.784844, -0.773522,
-0.786858, -0.779384, -0.779747, -0.774021, -0.783037, -0.772149,
-0.782173, -0.777113, -0.781948, -0.771789, -0.778248, -0.772194,
-0.778709, -0.772983, -0.777747, -0.768058, -0.780408, -0.771683,
-0.778456, -0.768034, -0.775712, -0.773012, -0.779896, -0.774031,
-0.78014, -0.766777, -0.776203, -0.76544, -0.778252, -0.772737,
-0.779192, -0.768182, -0.776646, -0.766838, -0.780146, -0.777821,
-0.77525, -0.767263, -0.776204, -0.770936, -0.771428, -0.770932,
-0.771523, -0.767795, -0.776909, -0.769284, -0.774799, -0.764459,
-0.769221, -0.762726, -0.776137)
#
# Shamos 
#
n.times.eBias.of.Shamos = 
c(NA,0.3663, 0.89682, 0.633113, 0.505874, 0.603023, 0.473895, 0.487659,
0.489384, 0.476839, 0.469394, 0.462004, 0.458936, 0.452936, 0.449515,
0.448673, 0.445731, 0.445814, 0.441364, 0.44031, 0.438242, 0.438782,
0.436527, 0.437623, 0.436053, 0.432546, 0.432426, 0.430401, 0.431926,
0.432082, 0.430452, 0.430432, 0.429754, 0.432423, 0.428553, 0.425571,
0.427235, 0.430183, 0.427581, 0.42523, 0.427974, 0.422912, 0.423649,
0.425633, 0.427378, 0.424166, 0.421973, 0.422797, 0.424211, 0.423859,
0.418814, 0.425744, 0.422809, 0.421883, 0.422088, 0.421188, 0.422089,
0.420665, 0.423664, 0.423703, 0.421651, 0.420567, 0.418563, 0.421256,
0.421777, 0.421369, 0.421629, 0.420986, 0.422662, 0.424769, 0.418858,
0.419291, 0.417354, 0.420359, 0.422569, 0.422599, 0.423583, 0.420204,
0.419188, 0.418784, 0.421808, 0.419616, 0.420788, 0.418362, 0.413992,
0.418777, 0.420093, 0.416376, 0.417955, 0.42028, 0.418692, 0.419003,
0.420277, 0.415905, 0.418705, 0.418363, 0.422299, 0.420162, 0.420947,
0.418638 )
#============================================
# Unbiasing factors for sigma based on the empirical biases  
#============================================
c5.unbiasing.factor.for.mad = function(n) {
  if ( n <= 100 ) {
     1+n.times.eBias.of.mad[n]/n
  } else {
     1 - 0.76213/n - 0.86413/n^2
  }
}
#----
c6.unbiasing.factor.for.Shamos = function(n) {
  if ( n <= 100 ) {
     1+n.times.eBias.of.Shamos[n]/n
  } else {
     1 + 0.414253297/n + 0.442396799/n^2
  }
}
#-----
# Unbiased mad
mad.unbiased = function(x,center=median(x),constant=1.4826,na.rm=FALSE){
  if (na.rm) x = x[!is.na(x)]
  n = length(x)
  if (n == 1) return(0)
  constant*median(abs(x-center))/c5.unbiasing.factor.for.mad(n) 
}
#-----
# Unbiased Shamos 
Shamos.unbiased = function(x,b=1.048358,IncludeEqual=FALSE,na.rm=FALSE){
  if (na.rm) x = x[!is.na(x)]
  n = length(x)
  if (n == 1) return(0)
  w1 = outer(x,x, "-")
  w2 = abs( w1[lower.tri(w1,diag=IncludeEqual)]  )
  b * median( w2 ) / c6.unbiasing.factor.for.Shamos(n) 
}
#==========================================================================

#============================================
# Empirical variances and REs
#============================================
# median  
#--------------------------------------------
n.times.eVar.of.median = 
c(1, 1.00000, 1.34635, 1.19303, 1.43389, 1.28817, 1.47356, 1.3459,
1.49572, 1.38327, 1.50882, 1.40875, 1.51947, 1.42981, 1.52489,
1.4457, 1.53018, 1.4585, 1.5333, 1.47018, 1.53828, 1.47705, 1.54201,
1.48503, 1.54375, 1.4896, 1.54618, 1.4954, 1.54755, 1.50053,
1.54821, 1.50573, 1.55155, 1.50908, 1.55153, 1.51232, 1.55313,
1.51483, 1.55501, 1.51731, 1.55316, 1.52058, 1.55515, 1.52236,
1.55681, 1.52398, 1.55704, 1.52487, 1.55616, 1.52666, 1.55835,
1.52978, 1.55921, 1.5298, 1.5584, 1.53299, 1.5589, 1.53375, 1.55981,
1.53485, 1.55935, 1.53611, 1.55938, 1.53728, 1.55975, 1.538,
1.56064, 1.53891, 1.56065, 1.5399, 1.55951, 1.54102, 1.56219,
1.5426, 1.56194, 1.54154, 1.56161, 1.54339, 1.56393, 1.54451,
1.5612, 1.54437, 1.56257, 1.54493, 1.563, 1.54415, 1.56428, 1.54483,
1.56404, 1.54629, 1.56344, 1.54774, 1.5631, 1.54825, 1.56292,
1.54661, 1.56359, 1.54767, 1.56424, 1.54842)
#
# Hodges-Lehmann (H1):  (i<j)
# 
n.times.eVar.of.HL1 = 
c(NA, 1.00000, 1.08713, 1.00000, 1.06166, 1.06186, 1.06301, 1.06282,
1.05881, 1.06084, 1.06022, 1.05602, 1.05667, 1.05652, 1.05617,
1.05465, 1.05415, 1.05405, 1.05324, 1.05454, 1.05365, 1.05273,
1.05324, 1.0529, 1.05214, 1.05182, 1.05255, 1.05106, 1.05251,
1.05184, 1.05142, 1.0517, 1.0521, 1.05118, 1.05082, 1.05119,
1.05121, 1.05022, 1.0513, 1.05065, 1.04984, 1.05096, 1.05036,
1.04996, 1.05038, 1.04965, 1.05039, 1.04928, 1.04948, 1.04986,
1.05016, 1.04991, 1.05012, 1.04885, 1.04929, 1.04968, 1.04958,
1.0495, 1.05013, 1.0489, 1.04916, 1.04921, 1.04848, 1.04944,
1.04876, 1.04956, 1.04938, 1.04908, 1.04791, 1.04901, 1.04823,
1.04912, 1.04915, 1.04982, 1.04891, 1.04864, 1.04854, 1.04939,
1.04931, 1.04971, 1.04859, 1.04941, 1.04839, 1.04903, 1.04838,
1.04792, 1.04946, 1.04776, 1.04868, 1.04835, 1.04861, 1.04905,
1.04811, 1.04881, 1.04812, 1.04768, 1.048, 1.04771, 1.04833,
1.04809)
#
# Hodges-Lehmann (H2):  (i<=j)
# 
n.times.eVar.of.HL2 = 
c(1, 1.00000, 1.0221, 1.09488, 1.07541, 1.07589, 1.08135, 1.07278,
1.07557, 1.07429, 1.0693, 1.06697, 1.06853, 1.06634, 1.06453,
1.06366, 1.06331, 1.06213, 1.06047, 1.06204, 1.06112, 1.05963,
1.0597, 1.05935, 1.05856, 1.0578, 1.05818, 1.05671, 1.05807,
1.05714, 1.05643, 1.05673, 1.0571, 1.05596, 1.05537, 1.05572,
1.05565, 1.05453, 1.05546, 1.05474, 1.05387, 1.05491, 1.05415,
1.05374, 1.05412, 1.05326, 1.0539, 1.05275, 1.05291, 1.05317,
1.05342, 1.05315, 1.05332, 1.05195, 1.05235, 1.05273, 1.05255,
1.05243, 1.05297, 1.05173, 1.05195, 1.05196, 1.05118, 1.0521,
1.05138, 1.05213, 1.05191, 1.05158, 1.05039, 1.05145, 1.0506,
1.05149, 1.0515, 1.05214, 1.0512, 1.05089, 1.05077, 1.05159,
1.05149, 1.05188, 1.0507, 1.05151, 1.05046, 1.05109, 1.05042,
1.04992, 1.05144, 1.04972, 1.05063, 1.05026, 1.05051, 1.05093,
1.04997, 1.05065, 1.04994, 1.04948, 1.04979, 1.04948, 1.05008,
1.04982)
#
# Hodges-Lehmann (H3):  all (i,j)
# 
n.times.eVar.of.HL3 = 
c(1,  1.00000, 1.08713, 1.09488, 1.07541, 1.06022, 1.0756, 1.07048,
1.0678, 1.06409, 1.06487, 1.06138, 1.06287, 1.06027, 1.06027,
1.059, 1.05874, 1.05737, 1.05674, 1.05813, 1.05732, 1.05574,
1.0564, 1.05601, 1.05528, 1.05451, 1.05528, 1.05377, 1.0552,
1.05428, 1.05385, 1.05413, 1.05453, 1.05341, 1.05303, 1.05338,
1.05338, 1.05224, 1.05333, 1.05263, 1.05181, 1.05283, 1.05221,
1.0518, 1.05221, 1.05137, 1.0521, 1.05097, 1.05116, 1.05145,
1.05175, 1.05149, 1.05169, 1.05035, 1.05079, 1.05117, 1.05104,
1.05092, 1.05151, 1.05029, 1.05052, 1.05054, 1.0498, 1.05074,
1.05004, 1.05081, 1.05063, 1.05031, 1.04913, 1.05019, 1.04939,
1.05029, 1.05031, 1.05095, 1.05003, 1.04974, 1.04964, 1.05046,
1.05038, 1.05077, 1.04963, 1.05044, 1.04941, 1.05004, 1.04938,
1.0489, 1.05044, 1.04872, 1.04964, 1.04929, 1.04955, 1.04998,
1.04902, 1.04971, 1.04902, 1.04857, 1.04888, 1.04858, 1.04919,
1.04894)
#
# mad
# 
n.times.eVar.of.mad = 
c(0, 0.79946, 0.925273, 0.706262, 1.15315, 0.956742, 1.23299, 1.07122,
1.26877, 1.13648, 1.28986, 1.17754, 1.30207, 1.20577, 1.31205,
1.22719, 1.3181, 1.24335, 1.32391, 1.25571, 1.32738, 1.26639,
1.33078, 1.27433, 1.33323, 1.2809, 1.33471, 1.28564, 1.33779,
1.29195, 1.3387, 1.29689, 1.34061, 1.30055, 1.3428, 1.30425,
1.34365, 1.30749, 1.34286, 1.31043, 1.34458, 1.31227, 1.34511,
1.31573, 1.34618, 1.31653, 1.34692, 1.31849, 1.34739, 1.3204,
1.34857, 1.32162, 1.34737, 1.32456, 1.34989, 1.32459, 1.35014,
1.32511, 1.35063, 1.32748, 1.34987, 1.32776, 1.35077, 1.3285,
1.35209, 1.3299, 1.35117, 1.33167, 1.35202, 1.33176, 1.35112,
1.33135, 1.35154, 1.33324, 1.35164, 1.33366, 1.35213, 1.33547,
1.35251, 1.33514, 1.35323, 1.33576, 1.35293, 1.33563, 1.35348,
1.33689, 1.35315, 1.33812, 1.35423, 1.33921, 1.35376, 1.33923,
1.35383, 1.33985, 1.35455, 1.33923, 1.35451, 1.34091, 1.35462,
1.34024)
#
# Shamos
# 
n.times.eVar.of.Shamos = 
c(0, 1.59892, 1.53306, 1.02774, 1.08122, 1.01489, 0.901695, 0.869883,
0.821846, 0.801195, 0.784302, 0.757997, 0.742364, 0.733795, 0.721381,
0.710463, 0.702206, 0.696355, 0.689304, 0.682576, 0.677834, 0.673426,
0.669209, 0.664687, 0.660845, 0.65759, 0.654576, 0.651069, 0.649137,
0.646831, 0.64478, 0.642552, 0.640414, 0.638647, 0.63687, 0.634802,
0.633504, 0.632065, 0.630238, 0.62956, 0.627677, 0.626901, 0.62521,
0.624766, 0.623313, 0.622503, 0.621483, 0.620335, 0.619385, 0.618427,
0.619019, 0.617564, 0.6167, 0.616325, 0.615573, 0.614773, 0.614336,
0.61279, 0.612515, 0.612359, 0.611124, 0.610934, 0.61042, 0.6096,
0.610383, 0.608696, 0.6085, 0.608193, 0.607842, 0.607259, 0.606627,
0.605944, 0.605839, 0.605594, 0.605285, 0.604711, 0.604607, 0.604362,
0.604131, 0.603519, 0.603562, 0.602853, 0.602788, 0.602295, 0.602219,
0.601793, 0.601317, 0.601539, 0.601603, 0.60098, 0.600633, 0.600537,
0.600121, 0.600117, 0.599976, 0.599378, 0.599373, 0.599506, 0.598895,
0.598179)
#-----------------------------------------------------------
#
# RE under N(0,1)
#
RE.median = function(n) {
  if ( n <= 0 ) return(NA)
  if ( n <= 100 ) {
    return(1/n.times.eVar.of.median[n])
  } else {
    tmp =ifelse(round(n)%%2==1, -0.6589-0.9430/n, -2.195+1.929/n)
    return(1/(1.57+tmp/n))
  } 
}
#----
RE.HL1 = function(n) {
  if ( n <= 1 ) return(NA)
  if ( n <= 100 ) {
    1 / n.times.eVar.of.HL1[n]
  } else {
    return( 1/(1.0472 + 0.1127/n + 0.8365/n^2) )
  } 
}
#----
RE.HL2 = function(n) {
  if ( n <= 0 ) return(NA)
  if ( n <= 100 ) {
    1 / n.times.eVar.of.HL2[n]
  } else {
    return( 1/(1.0472 + 0.2923/n + 0.2258/n^2) )
  }
}
#----
RE.HL3 = function(n) {
  if ( n <= 0 ) return(NA)
  if ( n <= 100 ) {
    1 / n.times.eVar.of.HL3[n]
  } else {
    return( 1/(1.0472 + 0.2022/n + 0.4343/n^2) )
  }
}
#====
c4.unbiasing.factor.for.SD = function(n) { 
   sqrt(2/(n-1)) * exp( lgamma(n/2) - lgamma( (n-1)/2 ) ) 
}
# 
RE.mad = function(n) {
  if ( n <= 1 ) return(NA)
  if ( n <= 100 ) {
    c4n = c4.unbiasing.factor.for.SD(n)
    (1-c4n^2) / (n.times.eVar.of.mad[n]/n)
  } else {
    tmp =ifelse(round(n)%%2==1, 0.2996-149.357/n, -2.417-153.01/n)
    return(1/(2.7027+tmp/n))
  } 
}
#----
RE.Shamos = function(n) {
  if ( n <= 1 ) return(NA)
  if ( n <= 100 ) {
    c4n = c4.unbiasing.factor.for.SD(n)
    (1-c4n^2) / (n.times.eVar.of.Shamos[n]/n)
  } else {
    return(1/(1.15875+2.822/n+12.238/n^2) )
  } 
}
#==========================================================================
#
# eVar under N(0,1)
# 
var.median = function(n) { 
  if ( n <= 0 ) return(NA)
  if ( n <= 100 ) {
     n.times.eVar.of.median[n]/n
  } else {
    (1/RE.median(n)) / n
  }
}
#----
var.HL1 = function(n) { 
  if ( n <= 1 ) return(NA)
  if ( n <= 100 ) {
     n.times.eVar.of.HL1[n]/n
  } else {
    (1/RE.HL1(n)) / n
  }
}
#----
var.HL2 = function(n) { 
  if ( n <= 0 ) return(NA)
  if ( n <= 100 ) {
     n.times.eVar.of.HL2[n]/n
  } else {
    (1/RE.HL2(n)) / n
  }
}
#----
var.HL3 = function(n) { 
  if ( n <= 0 ) return(NA)
  if ( n <= 100 ) {
     n.times.eVar.of.HL3[n]/n
  } else {
    (1/RE.HL3(n)) / n
  }
}
#----
var.mad = function(n) {
  if ( n <= 0 ) return(NA)
  if ( n <= 100 ) {
     n.times.eVar.of.mad[n]/n
  } else {
    (1/RE.mad(n))*(1-c4.unbiasing.factor.for.SD(n)^2)  
  }
}
#----
var.Shamos = function(n) {
  if ( n <= 0 ) return(NA)
  if ( n <= 100 ) {
     n.times.eVar.of.Shamos[n]/n
  } else {
    (1/RE.Shamos(n))*(1-c4.unbiasing.factor.for.SD(n)^2)  
  }
}
#============================================
# Unbiasing factors for sigma^2 based on the empirical biases and variances
#============================================
g5.unbiasing.factor.for.mad = function(n) {
  var.mad(n) + c5.unbiasing.factor.for.mad(n)^2 
}
#----
g6.unbiasing.factor.for.Shamos = function(n) {
  var.Shamos(n) + c6.unbiasing.factor.for.Shamos(n)^2 
}
#-----
# Unbiased mad^2
mad2.unbiased = function(x,center=median(x),constant=1.4826,na.rm=FALSE){
  if (na.rm) x = x[!is.na(x)]
  n = length(x)
  if (n == 1) return(0)
  (constant*median(abs(x-center)))^2 / g5.unbiasing.factor.for.mad(n) 
}
#-----
# Unbiased Shamos^2
Shamos2.unbiased = function(x,b=1.048358,IncludeEqual=FALSE,na.rm=FALSE){
  if (na.rm) x = x[!is.na(x)]
  n = length(x)
  if (n == 1) return(0)
  w1 = outer(x,x, "-")
  w2 = abs( w1[lower.tri(w1,diag=IncludeEqual)]  )
  (b*median(w2))^2 / g6.unbiasing.factor.for.Shamos(n) 
}
#==========================================================================

